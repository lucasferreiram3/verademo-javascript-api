pipeline {
    agent any 
    environment {
        caminhoPacote = 'uploadToVeracode/veracode-auto-pack-verademo-js-api-auto-pack-js.zip'
        wrapperVersion = '24.7.14.0'
        appName = 'verademo-javascript-api'
    }
    stages {
        stage('Clean') { 
            steps {
                sh 'rm -rf pipeline-scan-LATEST.zip pipeline-scan.jar'
                sh 'rm -rf veracode-wrapper.jar'
                sh 'rm -rf veracodeCli'
                sh 'rm -rf uploadToVeracode'
            }
        }

        stage('Veracode auto-pack') { 
            steps {
                withCredentials([usernamePassword(credentialsId: 'veracode-credentials', passwordVariable: 'VKEY', usernameVariable: 'VID')]) {
                    sh 'export VERACODE_API_KEY_ID=${VID}'
                    sh 'export VERACODE_API_KEY_SECRET=${VKEY}'
                    sh 'mkdir uploadToVeracode veracodeCli'
                    sh 'cd veracodeCli; curl -fsS https://tools.veracode.com/veracode-cli/install | sh'
                    sh 'veracodeCli/veracode package --source ${WORKSPACE} --trust --output ${WORKSPACE}/uploadToVeracode'
                    sh 'ls -l ${WORKSPACE}/uploadToVeracode'
                }
            }
        }

        stage('Veracode SAST - Sandbox Scan') { 
            steps {
                withCredentials([usernamePassword(credentialsId: 'veracode-credentials', passwordVariable: 'VKEY', usernameVariable: 'VID')]) {
                    sh 'curl -o veracode-wrapper.jar https://repo1.maven.org/maven2/com/veracode/vosp/api/wrappers/vosp-api-wrappers-java/${wrapperVersion}/vosp-api-wrappers-java-${wrapperVersion}.jar'
                    sh (""" java -jar veracode-wrapper.jar \
                        -vid "${VID}" \
                        -vkey "${VKEY}" \
                        -action uploadandscan \
                        -appname ${appName} \
                        -createprofile false \
                        -filepath ${caminhoPacote} \
                        -createsandbox true \
                        -sandboxname "${BRANCH_NAME}" \
                        -deleteincompletescan true \
                        -version "${BUILD_NUMBER}"
                    """)
                }
            }
        }

        stage('Veracode SAST - Pipeline Scan') { 
            steps {
                withCredentials([usernamePassword(credentialsId: 'veracode-credentials', passwordVariable: 'VKEY', usernameVariable: 'VID')]) {
                    sh 'curl -sSO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip'
                    sh 'unzip -o pipeline-scan-LATEST.zip'
                    sh 'java -jar pipeline-scan.jar --veracode_api_id "${VID}" --veracode_api_key "${VKEY}" --file ${caminhoPacote}'
                }
            }
        }
    }
}